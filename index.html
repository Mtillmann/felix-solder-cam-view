<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CAM VIEW</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script>

        let flipY = false;
        let flipX = false;

        function setState() {
            const data = JSON.stringify({
                flipY,
                flipX
            })

            localStorage.setItem('cam-view-state', data)
        }

        window.addEventListener('DOMContentLoaded', async () => {


            document.documentElement.setAttribute('data-bs-theme', window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')

            const video = document.querySelector('video')
            const canvas = document.querySelector('canvas')
            const button = document.querySelector('button')

            const constraints = {
                video: {
                    width: { ideal: 1920 },
                    height: { ideal: 1080 },
                    frameRate: { ideal: 60 },
                }
            }


            const stream = await navigator.mediaDevices.getUserMedia(constraints)
            video.srcObject = stream;
            await video.play()

            //get current video resolution
            const videoTrack = stream.getVideoTracks()[0]
            const settings = videoTrack.getSettings()


            //get aspect ratio
            const aspectRatio = settings.aspectRatio
            let ratio = '16x9'
            if (aspectRatio <= 4 / 3) {
                ratio = '4x3';
            }
            document.querySelector('.ratio').classList.add(`ratio-${ratio}`)

            function setInfo() {
                const settings = videoTrack.getSettings()
                //get current frame rate
                const frameRate = settings.frameRate
                

                //get actual size of video
                const domDims = video.getBoundingClientRect()

                const actualSize = Math.min(domDims.width / settings.width, domDims.height / settings.height)
                
                const perc = (Math.round(actualSize * 10000) * 0.01).toFixed(2) + '%'

                const actualWidth = Math.round(settings.width * actualSize)
                const actualHeight = Math.round(settings.height * actualSize)

                document.querySelector('#videoInfo').innerHTML = `${settings.width}x${settings.height}@${frameRate}fps (${perc}: ${actualWidth}x${actualHeight})`

            }

            setInfo()



            document.querySelector('.download').addEventListener('click', () => {
                canvas.width = video.videoWidth
                canvas.height = video.videoHeight

                const ctx = canvas.getContext('2d')
                ctx.translate(canvas.width / 2, canvas.height / 2)
                if (flipY) {
                    ctx.scale(-1, 1)
                }
                if (flipX) {
                    ctx.scale(1, -1)
                }
                ctx.translate(-canvas.width / 2, -canvas.height / 2)
                ctx.drawImage(video, 0, 0)


                const a = document.createElement('a')
                a.href = canvas.toDataURL()
                const now = new Date().toLocaleString()
                a.download = `solder-screenshot-${now}.png`
                a.click()
            });

            document.querySelector('.flip-vertical').addEventListener('click', (e) => {
                flipY = !flipY
                e.currentTarget.classList.toggle('active', flipY)
                video.classList.toggle('flipped-vertical', flipY)
                setState()
            });

            document.querySelector('.flip-horizontal').addEventListener('click', (e) => {
                flipX = !flipX
                e.currentTarget.classList.toggle('active', flipX)
                video.classList.toggle('flipped-horizontal', flipX)
                setState()
            });

            document.addEventListener('fullscreenchange', (e) => {

                document.querySelector('.toggle-fullscreen').classList.toggle('active', document.fullscreenElement)
                document.querySelector('body').classList.toggle('is-fullscreen', document.fullscreenElement)
            
                setInfo()
            })

            document.addEventListener('keydown', (e) => {
                if (e.key === 'f') {
                    document.querySelector('.toggle-fullscreen').click()
                }

                if (e.key === 'v') {
                    document.querySelector('.flip-vertical').click()
                }

                if (e.key === 'h') {
                    document.querySelector('.flip-horizontal').click()
                }

                if (e.key === 'd') {
                    document.querySelector('.download').click()
                }

            })

            document.querySelector('.toggle-fullscreen').addEventListener('click', (e) => {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen()
                } else {
                    document.exitFullscreen()
                }
            })

            const storedState = JSON.parse(localStorage.getItem('cam-view-state') ?? '{}')

            if (storedState.flipY) {
                document.querySelector('.flip-vertical').click()
            }
            if (storedState.flipX) {
                document.querySelector('.flip-horizontal').click()
            }



        })

    </script>
    <style>
        .flipped-vertical {
            transform: scaleX(-1) translate(50%, -50%);
        }

        .flipped-horizontal {
            transform: scaleY(-1) translate(-50%, 50%);
        }

        .flipped-vertical.flipped-horizontal {
            transform: rotate(180deg) translate(50%, 50%);
        }


        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }

        video {

            transform: translate(-50%, -50%);
        }

        .ratio {
            height: 100vh;
        }

        .is-fullscreen .visible-on-fullscreen {
            display: initial;
        }

        .is-fullscreen .hidden-on-fullscreen {
            display: none;
        }

        body:not(.is-fullscreen) .visible-on-fullscreen {
            display: none;
        }

        body:not(.is-fullscreen) .hidden-on-fullscreen {
            display: initial;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            transform: translate(-100%, -100%);

        }
    </style>
</head>

<body>

    <div class="position-absolute ratio">
        <video class="position-absolute start-50 top-50"></video>
    </div>

    <div id="videoInfo"
        class="small position-absolute start-0 bottom-0 bg-black text-white font-monospace bg-opacity-25">

    </div>

    <div class="btn-group-vertical btn-group-lg position-absolute top-50 translate-middle-y end-0">
        <button class="btn btn-lg btn-primary toggle-fullscreen">
            <i class="bi bi-fullscreen hidden-on-fullscreen"></i>
            <i class="bi bi-fullscreen-exit visible-on-fullscreen"></i><code class="ms-2 text-white">f</code>
        </button>
        <button class="btn btn-lg btn-primary flip-vertical">
            <i class="bi bi-symmetry-vertical"></i><code class="ms-2 text-white">v</code>
        </button>
        <button class="btn btn-lg btn-primary flip-horizontal">
            <i class="bi bi-symmetry-horizontal"></i><code class="ms-2 text-white">h</code>
        </button>
        <button class="btn btn-lg btn-primary download">
            <i class="bi bi-download"></i><code class="ms-2 text-white">d</code>
        </button>
    </div>


    <canvas></canvas>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
</body>

</html>